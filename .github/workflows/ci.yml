name: AI Platform CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write

env:
  PYTHON_VERSION: "3.13"
  NODE_VERSION: "24"
  IMAGE_NAME: lm-webui

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ----------------------------------------
  # STAGE 1: VALIDATE & TEST (Parallel)
  # ----------------------------------------
  validate:
    name: Code Quality & Security
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Python setup with caching
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      # Install Python dependencies using project requirements
      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          pip install pip-audit

      # Code quality checks using project's tools
      - name: Run Black formatting check
        run: cd backend && black --check .

      - name: Run isort import sorting check
        run: cd backend && isort --check-only .

      - name: Run flake8 linting
        run: cd backend && flake8 . --max-line-length=120 --ignore=E501,W503

      - name: Run mypy type checking
        run: cd backend && mypy app --ignore-missing-imports

      # Security audit — block on CRITICAL only
      - name: Audit Python dependencies
        run: cd backend && pip-audit --severity critical

      # Node.js setup with caching
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      # Blocking type check
      - name: Run TypeScript type check
        run: cd frontend && npm run typecheck

      # Security audit — block on high+critical
      - name: Audit npm dependencies
        run: cd frontend && npm audit --audit-level=high

  test:
    name: Unit & AI Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install backend dependencies
        run: cd backend && pip install -r requirements.txt -r requirements-test.txt

      # Blocking test run with minimum coverage enforced
      - name: Run backend tests
        run: |
          cd backend
          python -m pytest tests/ -v \
            --cov=app \
            --cov-report=xml \
            --cov-fail-under=70 \
            -x

      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

      # AI smoke test — blocking, exits on failure
      - name: Run AI functionality smoke test
        run: |
          cd backend
          python -c "
          import sys

          from app.services.model_registry import ModelRegistry
          print('✓ ModelRegistry import OK')

          from app.rag.processor import DocumentProcessor
          print('✓ RAG DocumentProcessor import OK')

          from app.main import app
          routes = [r.path for r in app.routes]
          required = ['/api/chat', '/api/rag', '/api/inference']
          missing = [r for r in required if r not in routes]
          if missing:
              print(f'✗ Missing AI routes: {missing}')
              sys.exit(1)
          print(f'✓ All {len(required)} required AI routes present')
          print('AI smoke test PASSED')
          "

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Run frontend tests with coverage
        run: cd frontend && npm run test:coverage

      - name: Upload frontend coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: frontend/coverage
          flags: frontend
          fail_ci_if_error: false

  # ----------------------------------------
  # STAGE 2: BUILD & SECURE (Depends on validate, test)
  # ----------------------------------------
  build:
    name: Build & Security Scan
    runs-on: ubuntu-latest
    needs: [validate, test]

    # FIX: Must be "write" — your original had "read" which caused the Trivy upload error
    permissions:
      security-events: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install backend dependencies
        run: cd backend && pip install -r requirements.txt

      - name: Validate OpenAPI schema
        run: |
          cd backend
          python -c "
          from app.main import app
          import json
          schema = app.openapi()
          assert 'info' in schema and 'paths' in schema, 'Invalid OpenAPI schema'
          print(f'✓ OpenAPI schema valid: {len(schema[\"paths\"])} endpoints')
          "

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build with GHA layer cache to avoid full rebuild each run
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # FIX: exit-code "1" — actually blocks pipeline on findings (was "0" before = toothless)
      - name: Scan container for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:test
          severity: CRITICAL,HIGH
          exit-code: "1"
          format: "sarif"
          output: "trivy-results.sarif"
          skip-files: |
            **/models/**
            **/blobs/**
            **/rerank/**

      # FIX: @v3 matches other codeql actions; if: always() uploads even on scan failure
      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      # Pass image to deploy stage — avoid rebuilding a 3rd time
      - name: Export Docker image
        run: docker save ${{ env.IMAGE_NAME }}:test | gzip > image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar.gz
          retention-days: 1

  # ----------------------------------------
  # STAGE 3: DEPLOY & VERIFY (Depends on build)
  # ----------------------------------------
  deploy:
    name: Runtime Verification
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      # Reuse image from build stage — no 3rd rebuild
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < image.tar.gz

      - name: Run container and verify health
        run: |
          docker run -d -p 8000:8000 --name app_test \
            --health-cmd="curl -f http://localhost:8000/health || exit 1" \
            --health-interval=5s \
            --health-retries=6 \
            ${{ env.IMAGE_NAME }}:test

          # Wait for healthy status instead of fixed sleep
          echo "Waiting for container to become healthy..."
          timeout 60 bash -c \
            'until [ "$(docker inspect --format="{{.State.Health.Status}}" app_test)" = "healthy" ]; do sleep 2; done'

          curl --fail http://localhost:8000/health
          curl --fail http://localhost:8000/api/health

          # AI endpoint: 401/403 = OK (auth required), 500/000 = real failure
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/chat \
            -H "Content-Type: application/json" \
            -d '{"messages":[{"role":"user","content":"test"}]}')
          if [ "$STATUS" = "500" ] || [ "$STATUS" = "000" ]; then
            echo "✗ AI endpoint returned unexpected $STATUS"
            exit 1
          fi
          echo "✓ AI endpoint responded $STATUS"
          echo "Container health verification passed"

      - name: Run Docker Compose integration test
        run: |
          docker-compose up -d

          # Wait for stack instead of fixed sleep
          timeout 60 bash -c 'until curl -sf http://localhost:7070/health; do sleep 3; done'
          echo "✓ Compose stack healthy"

          docker-compose ps
          docker-compose logs --tail=20 backend

      - name: Cleanup
        if: always()
        run: |
          docker rm -f app_test || true
          docker-compose down --volumes
