name: Production AI Orchestration CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "24.13"
  IMAGE_NAME: lm-webui

jobs:
  # ----------------------------------------
  # 1. STATIC VALIDATION
  # ----------------------------------------
  static:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Python lint
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python linting tools
        run: pip install ruff mypy

      - name: Run Ruff linting
        run: ruff check backend

      - name: Run mypy type checking
        run: mypy backend || true # optional strict typing later

      # Frontend type check
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Run TypeScript type check
        run: cd frontend && npm run typecheck

  # ----------------------------------------
  # 2. DEPENDENCY SECURITY
  # ----------------------------------------
  security:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    needs: static

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Audit Python dependencies
        run: cd backend && pip-audit

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Audit npm dependencies
        run: cd frontend && npm audit --audit-level=high

  # ----------------------------------------
  # 3. UNIT TESTS
  # ----------------------------------------
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: security
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run backend tests with coverage
        run: |
          cd backend
          python -m pytest tests/ -v --cov=app --cov-report=xml

      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-${{ matrix.python-version }}

  # Frontend tests (runs once, not in matrix)
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: security

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Run frontend tests
        run: cd frontend && npm test -- --coverage

      - name: Upload frontend coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          directory: frontend/coverage
          flags: frontend
          name: frontend

  # ----------------------------------------
  # 4. API CONTRACT STABILITY (LLM Infra Signal)
  # ----------------------------------------
  contract:
    name: OpenAPI Contract Validation
    runs-on: ubuntu-latest
    needs: [test, frontend-tests]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install backend dependencies
        run: cd backend && pip install -r requirements.txt

      - name: Generate and validate OpenAPI schema
        run: |
          cd backend
          python -c "from app.main import app; import json; print(json.dumps(app.openapi()))" > openapi.json
          test -s openapi.json
          echo "OpenAPI schema generated successfully ($(wc -c < openapi.json) bytes)"

  # ----------------------------------------
  # 5. DOCKER BUILD (REPRODUCIBLE)
  # ----------------------------------------
  build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: contract

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no cache for reproducibility)
        run: docker build --no-cache -t $IMAGE_NAME:test .

  # ----------------------------------------
  # 6. CONTAINER SECURITY SCAN
  # ----------------------------------------
  container_scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t $IMAGE_NAME:test .

      - name: Scan container for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:test
          severity: CRITICAL,HIGH
          exit-code: "1"

  # ----------------------------------------
  # 7. RUNTIME VERIFICATION
  # ----------------------------------------
  runtime:
    name: Runtime Integrity
    runs-on: ubuntu-latest
    needs: container_scan

    steps:
      - uses: actions/checkout@v4

      - name: Build image for runtime test
        run: docker build -t $IMAGE_NAME:test .

      - name: Run container and verify health
        run: |
          docker run -d -p 8000:8000 --name app_test $IMAGE_NAME:test
          sleep 10  # Give container time to start

          # Try health endpoint
          echo "Testing health endpoint..."
          curl --fail --retry 5 --retry-delay 5 --retry-max-time 30 http://localhost:8000/health

          # Also test API health endpoint
          echo "Testing API health endpoint..."
          curl --fail --retry 3 --retry-delay 2 http://localhost:8000/api/health

          echo "Container is healthy!"

      - name: Run Docker Compose integration test
        run: |
          docker-compose up -d
          sleep 30
          docker-compose ps
          docker-compose logs backend

          # Test health through docker-compose
          echo "Testing health through docker-compose..."
          curl --fail http://localhost:7070/health

      - name: Cleanup
        if: always()
        run: |
          docker rm -f app_test || true
          docker-compose down
